# Discord Voice Time Tracker Bot - Project Context

**Last Updated**: November 26, 2025  
**Repository**: Esmaill2/discord-bot  
**Branch**: mains  
**Node Version**: 16+  
**Primary Language**: JavaScript (Node.js)

---

## üéØ Project Overview

A comprehensive Discord bot that tracks voice channel activity with AFK checks, implements a complete gamification system (XP, levels, achievements, streaks, leaderboards), and provides a real-time web dashboard for monitoring and control. Includes Telegram integration for database backups.

### Core Purpose
1. Track user time in Discord voice channels
2. Send periodic AFK checks (every 30 minutes by default)
3. Require user confirmation within 2 minutes or auto-kick
4. Reward users with XP, levels, and achievements for voice activity
5. Provide web dashboard for real-time monitoring
6. Enable database backups via Telegram bot

---

## üìÅ Project Structure

```
discord bot/
‚îú‚îÄ‚îÄ Core Bot Files
‚îÇ   ‚îú‚îÄ‚îÄ bot.js                    # Main Discord bot logic (voice tracking, AFK checks, gamification integration)
‚îÇ   ‚îú‚îÄ‚îÄ server.js                 # Express web server + REST API + WebSocket (port 3001)
‚îÇ   ‚îú‚îÄ‚îÄ index.js                  # Standalone bot entry point (no dashboard)
‚îÇ   ‚îú‚îÄ‚îÄ database.js               # SQLite database operations (better-sqlite3)
‚îÇ   ‚îú‚îÄ‚îÄ gamification.js           # Gamification engine (XP, levels, achievements, streaks)
‚îÇ   ‚îú‚îÄ‚îÄ telegram-backup.js        # Telegram bot for database backups
‚îÇ
‚îú‚îÄ‚îÄ Configuration
‚îÇ   ‚îú‚îÄ‚îÄ config.json               # Bot token, testMode flag, Telegram credentials
‚îÇ   ‚îú‚îÄ‚îÄ settings.json             # AFK interval & confirmation timeout (auto-generated)
‚îÇ   ‚îú‚îÄ‚îÄ package.json              # Dependencies and npm scripts
‚îÇ
‚îú‚îÄ‚îÄ Dashboard (public/)
‚îÇ   ‚îú‚îÄ‚îÄ index.html                # Dashboard UI
‚îÇ   ‚îú‚îÄ‚îÄ style.css                 # Purple gradient theme, responsive design
‚îÇ   ‚îú‚îÄ‚îÄ script.js                 # WebSocket client, real-time updates
‚îÇ
‚îú‚îÄ‚îÄ Docker
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile                # Node 18 Alpine, 512MB memory limit
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml        # Port 3001, resource limits (1GB RAM, 2 CPU)
‚îÇ   ‚îú‚îÄ‚îÄ .dockerignore             # Excludes node_modules, logs, etc.
‚îÇ
‚îú‚îÄ‚îÄ Documentation
‚îÇ   ‚îú‚îÄ‚îÄ README.md                 # Original README
‚îÇ   ‚îú‚îÄ‚îÄ README_NEW.md             # Updated README with gamification
‚îÇ   ‚îú‚îÄ‚îÄ START_HERE.md             # Quick start guide (simplest)
‚îÇ   ‚îú‚îÄ‚îÄ GAMIFICATION_GUIDE.md     # Complete gamification documentation (200+ lines)
‚îÇ   ‚îú‚îÄ‚îÄ GAMIFICATION_SETUP.md     # Step-by-step setup instructions
‚îÇ   ‚îú‚îÄ‚îÄ ARCHITECTURE.md           # Visual system architecture diagram
‚îÇ   ‚îú‚îÄ‚îÄ IMPLEMENTATION_COMPLETE.md # Implementation summary
‚îÇ   ‚îú‚îÄ‚îÄ DASHBOARD.md              # Dashboard features and usage
‚îÇ   ‚îú‚îÄ‚îÄ DOCKER_GUIDE.md           # Docker deployment guide
‚îÇ   ‚îú‚îÄ‚îÄ PERFORMANCE_GUIDE.md      # Optimization for 100+ users
‚îÇ   ‚îú‚îÄ‚îÄ QUICK_START.md            # Quick setup guide
‚îÇ   ‚îú‚îÄ‚îÄ PROJECT_SUMMARY.md        # Project overview
‚îÇ   ‚îî‚îÄ‚îÄ .context.md               # This file
‚îÇ
‚îú‚îÄ‚îÄ Data (auto-generated)
‚îÇ   ‚îú‚îÄ‚îÄ bot-data.db               # SQLite database (created on first use)
‚îÇ   ‚îî‚îÄ‚îÄ logs/                     # Log files
‚îÇ
‚îî‚îÄ‚îÄ Git
    ‚îú‚îÄ‚îÄ .git/
    ‚îî‚îÄ‚îÄ .gitignore
```

---

## üîë Key Technologies

### Core Dependencies
- **discord.js** v14 - Discord API wrapper
- **express** - Web server framework
- **socket.io** - Real-time WebSocket communication
- **better-sqlite3** v9.2.2 - Fast synchronous SQLite database
- **node-telegram-bot-api** v0.65.1 - Telegram bot integration

### Discord.js Configuration
```javascript
// Required Intents
GatewayIntentBits.Guilds
GatewayIntentBits.GuildMembers
GatewayIntentBits.GuildVoiceStates
GatewayIntentBits.GuildMessages
GatewayIntentBits.GuildMessageReactions
GatewayIntentBits.MessageContent

// Required Partials
Partials.Message
Partials.Channel
Partials.Reaction
```

---

## üóÑÔ∏è Database Schema

### SQLite Database: `bot-data.db`

#### users
```sql
user_id TEXT PRIMARY KEY
username TEXT NOT NULL
total_time INTEGER DEFAULT 0        -- Total minutes in voice
xp INTEGER DEFAULT 0                 -- Total experience points
level INTEGER DEFAULT 1              -- Current level
current_streak INTEGER DEFAULT 0     -- Daily streak counter
last_active TEXT                     -- ISO timestamp of last activity
created_at TEXT DEFAULT CURRENT_TIMESTAMP
updated_at TEXT DEFAULT CURRENT_TIMESTAMP
```

#### achievements
```sql
id INTEGER PRIMARY KEY AUTOINCREMENT
user_id TEXT NOT NULL
achievement_type TEXT NOT NULL       -- e.g., 'NIGHT_OWL', 'MARATHON'
unlocked_at TEXT DEFAULT CURRENT_TIMESTAMP
UNIQUE(user_id, achievement_type)
FOREIGN KEY (user_id) REFERENCES users(user_id)
```

#### sessions
```sql
id INTEGER PRIMARY KEY AUTOINCREMENT
user_id TEXT NOT NULL
join_time TEXT NOT NULL              -- ISO timestamp
leave_time TEXT                      -- ISO timestamp
duration INTEGER DEFAULT 0           -- Minutes
xp_earned INTEGER DEFAULT 0          -- XP from this session
created_at TEXT DEFAULT CURRENT_TIMESTAMP
FOREIGN KEY (user_id) REFERENCES users(user_id)
```

#### leaderboard_snapshots
```sql
id INTEGER PRIMARY KEY AUTOINCREMENT
period_type TEXT NOT NULL            -- 'weekly' or 'monthly'
period_start TEXT NOT NULL
period_end TEXT NOT NULL
rankings TEXT NOT NULL               -- JSON data
created_at TEXT DEFAULT CURRENT_TIMESTAMP
```

---

## üéÆ Gamification System

### XP System
- **Base Rate**: 1 XP per minute in voice channel
- **Calculation**: XP awarded when user LEAVES voice channel
- **Formula**: `baseXP = durationMinutes * streakMultiplier`

### Level System
- **Formula**: `Level = floor(sqrt(XP / 100)) + 1`
- **Progression**:
  - Level 1: 0 XP
  - Level 2: 100 XP
  - Level 5: 1,600 XP
  - Level 10: 8,100 XP
  - Level 25: 57,600 XP
  - Level 50: 240,100 XP
  - Level 100: 980,100 XP

### Streak System
- **Tracking**: Daily activity (join voice channel = active day)
- **Reset**: Missing a day resets streak to 1
- **Multipliers**:
  - Days 1-6: 1.0x XP (base)
  - Days 7-13: 1.25x XP
  - Days 14-29: 1.5x XP
  - Days 30+: 2.0x XP (DOUBLE!)

### Achievements
```javascript
{
  NIGHT_OWL: {
    name: 'Night Owl',
    description: 'Active between 12 AM - 6 AM',
    check: hour >= 0 && hour < 6
  },
  MARATHON: {
    name: 'Marathon',
    description: 'Stay in voice for 6+ hours continuously',
    check: sessionDuration >= 6 hours
  },
  DEDICATED: {
    name: 'Dedicated',
    description: 'Maintain a 7-day streak',
    check: current_streak >= 7
  },
  VETERAN: { level: 10 },
  MASTER: { level: 25 },
  LEGEND: { level: 50 },
  CENTURY: { level: 100 }
}
```

### Role Rewards
```javascript
{
  5: 'Bronze Member',
  10: 'Silver Member',
  25: 'Gold Member',
  50: 'Platinum Member',
  100: 'Diamond Legend'
}
```
**Note**: Server admins must create these roles in Discord for auto-assignment.

---

## ‚öôÔ∏è Configuration Files

### config.json
```json
{
  "token": "MTM2NzI3Njk4MzQ2NTAyMTU2MQ.GhLNw6.wJDfleAnk9VNr7c54OOFNAW38bOFkkP9zv5CPU",
  "testMode": false,
  "telegram": {
    "botToken": "YOUR_TELEGRAM_BOT_TOKEN",
    "chatId": "YOUR_CHAT_ID"
  }
}
```

### settings.json (auto-generated)
```json
{
  "afkInterval": 30,      // Minutes between AFK checks
  "confirmTimeout": 2     // Minutes to confirm before kick
}
```

### Test Mode
When `testMode: true` in config.json:
- AFK interval: 1 minute
- Confirmation timeout: 30 seconds

---

## üîÑ Core Bot Logic Flow

### User Joins Voice Channel
1. `voiceStateUpdate` event fired
2. `handleUserJoinVoice(userId, channelId, guildId)` called
3. `gamification.handleUserJoin(userId, username)`:
   - Creates user profile if new
   - Updates streak (checks last_active, increments or resets)
   - Starts session in database
4. Starts 30-minute AFK timer
5. Broadcasts update to dashboard

### User Leaves Voice Channel
1. `voiceStateUpdate` event fired
2. `handleUserLeaveVoice(userId)` called
3. Calculates session duration
4. `gamification.handleUserLeave(userId)`:
   - Calculates XP with streak multiplier
   - Updates total_time in database
   - Checks for level-up
   - Checks for achievement unlocks
   - Ends session in database
5. Clears AFK timer
6. Logs XP earned, level-ups, achievements
7. Broadcasts update to dashboard

### AFK Check Flow
1. 30-minute timer expires
2. `sendAFKCheck()` called (queued to prevent rate limiting)
3. Message sent to text channel: "Are you still active?"
4. User has 2 minutes to:
   - React with ‚úÖ emoji, OR
   - Type `!here` command
5. If confirmed: `handleUserConfirmation()` ‚Üí reset timer
6. If not confirmed: `kickUserFromVoice()` ‚Üí disconnect user

---

## üåê REST API Endpoints

### Bot Control
- `GET /api/status` - Bot status, uptime, stats, active users array
- `GET /api/users` - Active voice users with session times
- `GET /api/settings` - Current afkInterval and confirmTimeout
- `POST /api/settings` - Update settings (validates 1-180 min, 1-10 min)
- `POST /api/bot/start` - Start the bot
- `POST /api/bot/stop` - Stop the bot
- `POST /api/bot/restart` - Restart bot (reloads module)

### Gamification
- `GET /api/gamification/profile/:userId` - User profile with XP, level, achievements, streak
- `GET /api/gamification/leaderboards` - All leaderboard data (5 categories)
- `GET /api/gamification/achievements` - List of all available achievements
- `GET /api/gamification/role-rewards` - Role reward level thresholds

---

## üì± Telegram Backup Bot

### Setup Requirements
1. Create bot with [@BotFather](https://t.me/BotFather) on Telegram
2. Get bot token from BotFather
3. Start chat with bot, send any message
4. Get chat ID from `https://api.telegram.org/bot<TOKEN>/getUpdates`
5. Add credentials to config.json

### Commands
- `/backup` - Download bot-data.db file
- `/stats` - View database statistics (user count, file size, top 5 users)
- `/schedule` - Toggle daily auto-backups (24-hour interval)
- `/help` or `/start` - Show available commands

### Security
- Only responds to configured `chatId`
- Unauthorized requests receive "Unauthorized access" message
- No public access to database

---

## üöÄ NPM Scripts

```json
{
  "start": "node server.js",              // Dashboard + Bot (port 3001)
  "bot": "node index.js",                 // Bot only (no dashboard)
  "telegram-backup": "node telegram-backup.js"  // Telegram backup bot
}
```

---

## üìä Performance Specifications

### Limits
- **MAX_CONCURRENT_USERS**: 500
- **WARN_USER_THRESHOLD**: 100 (logs warning at multiples of 50)
- **MAX_DISPLAY_USERS**: 200 (dashboard display limit)

### Rate Limiting
- **Message Queue**: 500ms delay between Discord messages
- **Dashboard Updates**: 2-second throttle for WebSocket broadcasts
- **Dashboard Polling**: 5-second fallback if WebSocket disconnects

### Memory Management
- Docker memory limit: 512MB (can scale to 1GB in docker-compose.yml)
- CPU limit: 2 cores
- Health checks every 30 seconds

---

## üêõ Common Issues & Solutions

### Database Not Creating
**Symptom**: bot-data.db file doesn't exist  
**Cause**: No user has joined/left voice channel yet  
**Solution**: Database creates automatically on first user activity

**Alternative**: better-sqlite3 build issues  
**Solution**: `npm install better-sqlite3 --build-from-source`

### XP Not Tracking
**Symptom**: Console shows no XP messages  
**Cause**: User not actually leaving voice channel  
**Solution**: XP only awarded when user LEAVES voice (session ends)

### Telegram Bot Not Responding
**Symptom**: No response to commands  
**Causes**:
1. Wrong chat ID in config.json
2. telegram-backup.js not running
3. Bot token incorrect
**Solution**: Verify credentials, ensure script is running

### Reactions Not Working
**Symptom**: ‚úÖ reaction doesn't confirm AFK check  
**Cause**: Missing Partials or Intents  
**Solution**: Already configured correctly in bot.js (Partials.Message, Partials.Reaction)

### Port 3001 In Use
**Symptom**: Server fails to start  
**Solution**: Change PORT constant in server.js or kill process on 3001

### Docker Desktop Not Running
**Symptom**: Docker commands fail  
**Solution**: Start Docker Desktop application

---

## üîß Key Code Locations

### Main Data Structures (bot.js)
```javascript
voiceTimeTracking = new Map()     // userId -> { joinTime, totalTime }
afkCheckTimers = new Map()        // userId -> { timer, channelId, guildId }
awaitingConfirmation = new Map()  // userId -> { timeout, message }
```

### Critical Functions

**bot.js**:
- `handleUserJoinVoice()` - Lines ~145-175
- `handleUserLeaveVoice()` - Lines ~177-210
- `sendAFKCheck()` / `sendAFKCheckImmediate()` - Lines ~230-280
- `handleUserConfirmation()` - Lines ~340-365
- `kickUserFromVoice()` - Lines ~367-390

**gamification.js**:
- `handleUserJoin()` - Creates profile, updates streak
- `handleUserLeave()` - Awards XP, checks achievements
- `checkAchievements()` - Validates and unlocks achievements
- `getLeaderboards()` - Returns all leaderboard data

**database.js**:
- `initializeTables()` - Creates schema
- `addXP()` - Adds XP and calculates level
- `updateStreak()` - Daily streak logic
- `unlockAchievement()` - Achievement unlocking

**server.js**:
- `broadcastUpdate()` - WebSocket broadcast function
- API route handlers - Lines ~40-145
- Gamification endpoints - Lines ~147-195

---

## üé® Dashboard Features

### Real-Time Stats (WebSocket)
- Bot status (running/stopped)
- Uptime
- Server count
- Active users count
- AFK checks sent
- Users kicked
- Memory usage

### User Cards
- Username with discriminator
- Session time (current session)
- Total time (all sessions)
- Avatar display
- Real-time updates

### Activity Log
- Join/leave events
- Level-ups
- Achievement unlocks
- AFK checks
- Confirmation responses
- Kick events

### Controls
- Start/Stop/Restart buttons
- Settings panel (AFK interval, confirmation timeout)
- Save settings with validation

---

## üê≥ Docker Deployment

### Build & Run
```bash
docker build -t discord-bot .
docker-compose up -d
```

### Configuration
- Base image: node:18-alpine
- Memory limit: 512MB (Dockerfile), 1GB (docker-compose)
- CPU limit: 2 cores
- Port: 3001:3001
- Health check: HTTP GET localhost:3001 every 30s
- Restart policy: unless-stopped

---

## üìù Important Notes for Future Development

### When Adding Features
1. **Database Changes**: Update `database.js` schema, add migration logic if needed
2. **API Endpoints**: Add to `server.js`, follow RESTful conventions
3. **Gamification Logic**: Modify `gamification.js`, maintain XP formula consistency
4. **Dashboard Updates**: Update HTML/CSS/JS in public/ folder, maintain WebSocket sync
5. **Documentation**: Update relevant .md files, especially START_HERE.md and GAMIFICATION_GUIDE.md

### Code Style
- Use ES6+ syntax (const/let, arrow functions, async/await)
- Console logs with emojis for visibility (üé§, üíé, üèÖ, etc.)
- Error handling with try-catch blocks
- Validate user input (especially API endpoints)
- Comment complex logic

### Performance Considerations
- Always use message queue for Discord messages (rate limiting)
- Throttle dashboard updates (current: 2 seconds)
- Limit API response sizes (current: 200 max users)
- Use database indexes for frequent queries
- Monitor memory with `process.memoryUsage()`

### Testing
- Use `testMode: true` for rapid testing (1 min / 30 sec timers)
- Test with multiple simultaneous users
- Verify database persistence (restart bot, check data)
- Test Telegram bot with unauthorized users
- Check dashboard across devices

---

## üîê Security Considerations

### Sensitive Data
- Discord bot token in config.json (gitignored)
- Telegram bot token in config.json (gitignored)
- Database file (bot-data.db) not in git
- Never commit config.json with real tokens

### Access Control
- Dashboard: localhost only (no external access by default)
- Telegram bot: chatId whitelist
- API: No authentication (assumes localhost)

### Recommendations for Production
1. Add API authentication (JWT or API keys)
2. Use environment variables instead of config.json
3. Enable HTTPS for dashboard
4. Implement rate limiting on API endpoints
5. Add input sanitization for user data
6. Regular database backups to external storage

---

## üìà Future Enhancement Ideas

### High Priority
- [ ] Dashboard tab for leaderboards visualization
- [ ] User profile page with achievement showcase
- [ ] Level-up notifications in Discord (DM or channel)
- [ ] Achievement unlock notifications in Discord
- [ ] Configurable achievement system per server

### Medium Priority
- [ ] Custom achievements (server admin panel)
- [ ] Reward shop (virtual currency, cosmetic items)
- [ ] Voice activity analytics (charts, graphs)
- [ ] Seasonal competitions (monthly resets)
- [ ] Profile cards as Discord embeds
- [ ] Multi-server support (different databases per server)

### Low Priority
- [ ] Multi-language support
- [ ] Advanced role management (custom role rewards)
- [ ] Integration with other Discord bots
- [ ] Export data to CSV/JSON
- [ ] Mobile app for dashboard

---

## üÜò Troubleshooting Guide

### Bot Won't Start
1. Check Discord token in config.json
2. Verify Node.js version (16+)
3. Run `npm install` to ensure dependencies
4. Check console for specific error messages
5. Ensure port 3001 is available

### Database Issues
1. Check write permissions in bot directory
2. Verify better-sqlite3 installation
3. Delete bot-data.db and let it recreate
4. Check disk space

### Gamification Not Working
1. Verify user actually joins/leaves voice
2. Check console for gamification errors
3. Query database directly to verify data
4. Test with single user first

### Dashboard Not Updating
1. Check WebSocket connection in browser console
2. Verify server.js is broadcasting updates
3. Check for JavaScript errors in browser
4. Try hard refresh (Ctrl+F5)

---

## üìû Quick Reference

### Start the Bot
```bash
npm start                    # Dashboard + Bot
npm run bot                  # Bot only
npm run telegram-backup      # Telegram bot
```

### Access Points
- **Dashboard**: http://localhost:3001
- **API Base**: http://localhost:3001/api/
- **Database**: ./bot-data.db

### Key Files to Edit
- **Bot Logic**: bot.js
- **Gamification**: gamification.js
- **Database**: database.js
- **API**: server.js
- **Config**: config.json, settings.json
- **Dashboard UI**: public/index.html, public/style.css, public/script.js

### Console Log Patterns
- `üé§` User joined voice
- `üëã` User left voice
- `üíé` XP earned
- `üéâ` Level up
- `üèÖ` Achievement unlocked
- `üî•` Streak milestone
- `‚ö†Ô∏è` Warning/error

---

## üìö Documentation Hierarchy

1. **START_HERE.md** - Absolute beginner, quickest start
2. **GAMIFICATION_SETUP.md** - Step-by-step setup with screenshots
3. **GAMIFICATION_GUIDE.md** - Complete feature reference
4. **ARCHITECTURE.md** - Visual system diagram
5. **IMPLEMENTATION_COMPLETE.md** - What was added/changed
6. **README_NEW.md** - Full project README
7. **.context.md** - This file (for AI assistants)

---

## üéØ Project Goals & Philosophy

### Primary Goals
1. **Engage Users**: Gamification encourages voice channel activity
2. **Fair Rewards**: XP based on actual time spent, streak rewards dedication
3. **Transparent**: All data visible via dashboard and API
4. **Reliable**: Handles 100+ concurrent users, auto-recovery
5. **Accessible**: Easy setup, clear documentation

### Design Principles
- **Simplicity**: One command to start (`npm start`)
- **Visibility**: Console logs and dashboard for monitoring
- **Persistence**: Database ensures no data loss
- **Scalability**: Queue systems prevent rate limiting
- **Modularity**: Separate files for concerns (bot, server, db, gamification)

---

**This context file should provide complete understanding for editing, improving, or extending the bot.** All architectural decisions, code locations, and system behaviors are documented here.

**Last Updated**: November 26, 2025  
**Maintainer**: Project owner (Esmaill2)  
**Status**: ‚úÖ Fully operational, production-ready
